@page "{id}"
@model FuerzaGServicial.Pages.Services.Edit
@{
    ViewData["Title"] = "Editar Servicio";
}

<div class="container mt-4 mb-5">
    <h2 class="mb-4">Editar Servicio</h2>

    @if (Model.ValidationErrors.Any())
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <h6 class="alert-heading mb-2">
                <i class="fas fa-exclamation-triangle me-1"></i> Errores de validación:
            </h6>
            <ul class="mb-0 small">
                @foreach (var error in Model.ValidationErrors)
                {
                    <li>@error</li>
                }
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
    }

    <form method="post" class="card card-body shadow-sm" id="serviceForm" novalidate>
        <input type="hidden" asp-for="Service.Id" />

        <div class="row g-3">
            <div class="col-md-6">
                <label asp-for="Service.Name" class="form-label">Nombre del servicio *</label>
                <input asp-for="Service.Name"
                       class="form-control"
                       placeholder="Ej: Cambio de aceite"
                       required
                       minlength="3"
                       pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñÜü\s0-9%#()]+$"
                       maxlength="100"
                       autocomplete="off" />
                <span asp-validation-for="Service.Name" class="text-danger small"></span>
            </div>

            <div class="col-md-6">
                <label asp-for="Service.Type" class="form-label">Tipo *</label>
                <select asp-for="Service.Type" class="form-select" required>
                    <option value="">-- Selecciona el tipo --</option>
                    <option value="Preventivo">Preventivo</option>
                    <option value="Correctivo">Correctivo</option>
                </select>
                <span asp-validation-for="Service.Type" class="text-danger small"></span>
            </div>

            <div class="col-md-6">
                <label asp-for="Service.Price" class="form-label">Precio *</label>
                <div class="input-group">
                    <span class="input-group-text">Bs</span>
                    <input asp-for="Service.Price"
                           type="text"
                           inputmode="decimal"
                           pattern="^\d+(\.\d{1,2})?$"
                           placeholder="Ej: 1250.50"
                           required
                           class="form-control"
                           id="Service_Price"
                           autocomplete="off"
                           oninput="this.value=this.value.replace(/[^0-9.]/g,'');" />
                </div>
                <span asp-validation-for="Service.Price" class="text-danger small"></span>
            </div>

            <div class="col-12">
                <label asp-for="Service.Description" class="form-label">Descripción *</label>
                <textarea asp-for="Service.Description"
                          class="form-control"
                          rows="3"
                          placeholder="Detalles del servicio"
                          required
                          minlength="3"
                          maxlength="255"
                          pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñÜü\s0-9%#()]+$"
                          autocomplete="off"></textarea>
                <span asp-validation-for="Service.Description" class="text-danger small"></span>
            </div>
        </div>

        <div class="mt-4 d-flex gap-2">
            <button type="button" class="btn btn-dark" id="btnSaveService">
                <i class="fas fa-save me-1"></i> Actualizar
            </button>
            <a asp-page="/Services/ServicePage" class="btn btn-outline-secondary">
                <i class="fas fa-times me-1"></i> Cancelar
            </a>
        </div>

        <div class="mt-3">
            <small class="text-muted">* Campos obligatorios</small>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('serviceForm');
            const nameInput = document.getElementById('Service_Name');
            const typeSelect = document.getElementById('Service_Type');
            const priceInput = document.getElementById('Service_Price');
            const descriptionInput = document.getElementById('Service_Description');

            const nameErrorSpan = document.querySelector('[data-valmsg-for="Service.Name"]');
            const typeErrorSpan = document.querySelector('[data-valmsg-for="Service.Type"]');
            const priceErrorSpan = document.querySelector('[data-valmsg-for="Service.Price"]');
            const descriptionErrorSpan = document.querySelector('[data-valmsg-for="Service.Description"]');

            [nameInput, typeSelect, priceInput, descriptionInput].forEach(input => {
                if (!input) return;
                input.addEventListener('input', function () {
                    this.classList.remove('is-invalid');
                    const errorSpan = document.querySelector(`[data-valmsg-for="${this.id.replace('_', '.')}"]`);
                    if (errorSpan) errorSpan.textContent = '';
                });
            });

            document.getElementById('btnSaveService').addEventListener('click', function () {
                [nameInput, typeSelect, priceInput, descriptionInput].forEach(el => el.classList.remove('is-invalid', 'is-valid'));
                [nameErrorSpan, typeErrorSpan, priceErrorSpan, descriptionErrorSpan].forEach(span => span.textContent = '');

                let valid = true;

                const nameValue = nameInput.value.trim();
                const nameRegex = /^[A-Za-zÁÉÍÓÚáéíóúÑñÜü\s0-9]+$/;
                if (!nameValue || nameValue.length < 3 || !nameRegex.test(nameValue)) {
                    nameInput.classList.add('is-invalid');
                    nameErrorSpan.textContent = 'El nombre debe tener al menos 3 caracteres y solo letras/números.';
                    valid = false;
                } else {
                    nameInput.classList.add('is-valid');
                }

                if (!typeSelect.value) {
                    typeSelect.classList.add('is-invalid');
                    typeErrorSpan.textContent = 'Debes seleccionar un tipo de servicio.';
                    valid = false;
                } else {
                    typeSelect.classList.add('is-valid');
                }

                const priceStr = priceInput.value.replace(/,/g, '').trim();
                const price = parseFloat(priceStr);
                const pricePattern = /^\d+(\.\d{1,2})?$/;
                if (!priceStr || isNaN(price) || price <= 0 || !pricePattern.test(priceStr)) {
                    priceInput.classList.add('is-invalid');
                    priceErrorSpan.textContent = 'Ingrese un precio válido mayor a 0 con hasta 2 decimales.';
                    valid = false;
                } else {
                    priceInput.classList.add('is-valid');
                }

                const description = descriptionInput.value.trim();
                const prohibitedChars = /[<>\/\\|]/;
                if (!description || description.length < 3 || prohibitedChars.test(description)) {
                    descriptionInput.classList.add('is-invalid');
                    descriptionErrorSpan.textContent = 'La descripción debe tener al menos 3 caracteres y no contener <>/\\|.';
                    valid = false;
                } else {
                    descriptionInput.classList.add('is-valid');
                }

                if (valid && form.checkValidity()) {
                    const btn = this;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Actualizando...';
                    form.submit();
                } else {
                    form.classList.add('was-validated');
                }
            });
        });
    </script>
}
