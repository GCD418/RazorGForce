@page
@model FuerzaGServicial.Pages.UserAccounts.ChangePasswordModel
@{
    ViewData["Title"] = "Cambiar contraseña";
}

<div class="page-header py-4 bg-light mb-4">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h3 class="text-dark">Configuración de Cuenta</h3>
            </div>
        </div>
    </div>
</div>
<!-- Page Header End -->

<!-- Account Settings Start -->
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-5 text-center">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <i class="fas fa-user-cog fa-3x text-primary mb-4"></i>
                    <h3 class="mb-3">Configuración de Cuenta</h3>
                    <p class="text-muted mb-3">Administra la seguridad de tu cuenta</p>
                    
                    <button class="btn btn-primary btn-lg" onclick="openChangePasswordModal()">
                        <i class="fas fa-key me-2"></i>Cambiar Contraseña
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="changePasswordModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-sm">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeModalBtn"></button>
            </div>
            <div class="modal-body p-4 p-md-5 pt-0">
                
                <div class="text-center mb-4">
                    <div class="mb-3">
                        <i class="bi bi-shield-lock text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <h3 class="fw-bold mb-1">Cambio de Contraseña</h3>
                    <p class="text-muted mb-0">Por seguridad, debes actualizar tu contraseña</p>
                </div>

                <form method="post" asp-page="/UserAccounts/ChangePassword" id="changePasswordForm">
                    
                    
                    <div class="mb-3">
                        <label for="Input_CurrentPassword" class="form-label">Contraseña Actual</label>
                        <div class="input-group password-group">
                            <span class="input-group-text">
                                <i class="bi bi-lock"></i>
                            </span>
                            <input type="password"
                                   name="Input.CurrentPassword"
                                   class="form-control" 
                                   autocomplete="current-password"
                                   id="Input_CurrentPassword"
                                   required />
                            <button class="btn" 
                                    type="button" 
                                    onclick="togglePasswordVisibility('Input_CurrentPassword', 'eyeIconCurrent')">
                                <i class="fa fa-eye-slash" id="eyeIconCurrent"></i>
                            </button>
                        </div>
                        <span class="text-danger small" id="error_CurrentPassword"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label for="Input_NewPassword" class="form-label">Nueva Contraseña</label>
                        <div class="input-group password-group">
                            <span class="input-group-text">
                                <i class="bi bi-key"></i>
                            </span>
                            <input type="password"
                                   name="Input.NewPassword"
                                   class="form-control"
                                   autocomplete="new-password"
                                   id="Input_NewPassword"
                                   required 
                                   minlength="8" />
                            <button class="btn" 
                                    type="button" 
                                    onclick="togglePasswordVisibility('Input_NewPassword', 'eyeIconNew')">
                                <i class="fa fa-eye-slash" id="eyeIconNew"></i>
                            </button>
                        </div>
                        <div class="form-text">Mínimo 8 caracteres, incluir mayúsculas, minúsculas y números</div>
                        <span class="text-danger small" id="error_NewPassword"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label for="Input_ConfirmPassword" class="form-label">Confirmar Nueva Contraseña</label>
                        <div class="input-group password-group">
                            <span class="input-group-text">
                                <i class="bi bi-check-circle"></i>
                            </span>
                            <input type="password"
                                   name="Input.ConfirmPassword"
                                   class="form-control"
                                   autocomplete="new-password"
                                   id="Input_ConfirmPassword"
                                   required />
                            <button class="btn" 
                                    type="button" 
                                    onclick="togglePasswordVisibility('Input_ConfirmPassword', 'eyeIconConfirm')">
                                <i class="fa fa-eye-slash" id="eyeIconConfirm"></i>
                            </button>
                        </div>
                        <span class="text-danger small" id="error_ConfirmPassword"></span>
                    </div>
                    
                    <button type="submit" id="submitChangePassword" class="btn btn-primary w-100 py-2  mb-3">
                        <i class="bi bi-shield-check me-1"></i> Cambiar Contraseña
                    </button>
                    
                    @if (Model.validationErrors != null && Model.validationErrors.Any())
                    {
                        <div class="alert alert-danger alert-dismissible fade show small mt-2" style="font-size: 0.8rem;">
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            <ul class="mb-0">
                                @foreach (var error in Model.validationErrors)
                                {
                                    <li>@error</li>
                                }
                            </ul>
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.errorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible fade show small mt-2" style="font-size: 0.8rem;">
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            @Model.errorMessage
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.successMessage))
                    {
                        <div class="alert alert-success alert-dismissible fade show small mt-2" style="font-size: 0.8rem;">
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            @Model.successMessage
                        </div>
                    }
                    
                </form>

            </div>
        </div>
    </div>
</div>

<style>
    .password-group .btn {
        border: 1px solid #ced4da;
        border-left: none;
        background-color: #fff;
        color: #6c757d;
        padding: 0.375rem 0.75rem;
    }
    
    .password-group .btn:hover {
        background-color: #f8f9fa;
        color: #495057;
    }
    
    .password-group input {
        border-right: none;
    }
    
    .password-group .input-group-text {
        background-color: #e9ecef;
        border-right: none;
    }
</style>

<script>
    @if (Model.mustShowModal || !string.IsNullOrEmpty(Model.successMessage))
    {
        <text>
        document.addEventListener('DOMContentLoaded', function() {
            const shouldAutoClose = @((!string.IsNullOrEmpty(Model.successMessage)).ToString().ToLower());
            if (window.openChangePasswordModal) {
                window.openChangePasswordModal();
                
                if (shouldAutoClose) {
                    setTimeout(function() {
                        const modalElement = document.getElementById('changePasswordModal');
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }, 2500);
                }
            }
        });
        </text>
    }
    
    function togglePasswordVisibility(inputId, iconId) {
        const passwordInput = document.getElementById(inputId);
        const eyeIcon = document.getElementById(iconId);
        
        if (!passwordInput || !eyeIcon) return;
        
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        if (type === 'text') {
            eyeIcon.classList.remove('fa-eye-slash');
            eyeIcon.classList.add('fa-eye');
        } else {
            eyeIcon.classList.remove('fa-eye');
            eyeIcon.classList.add('fa-eye-slash');
        }
    }
    
    function openChangePasswordModal() {
        const modalElement = document.getElementById('changePasswordModal');
        const modal = new bootstrap.Modal(modalElement);
        const closeBtn = document.getElementById('closeModalBtn');
        
        closeBtn.style.display = 'block';
        modalElement.setAttribute('data-bs-backdrop', 'static');
        modalElement.setAttribute('data-bs-keyboard', 'true');
        

        document.getElementById('changePasswordForm').reset();

        document.querySelectorAll('.alert').forEach(alert => alert.remove());
        
        modal.show();
    }
</script>